# Отчёт: RAG система для финансовой грамотности

**Проект**: Retrieval-Augmented Generation система для ответов на вопросы по финансовой грамотности
**Дата**: Декабрь 2025
**Стек**: Python 3.11, FAISS, Streamlit, DeepSeek API, Docker

---

## 1. Описание функционала интерфейса

### 1.1 Веб-интерфейс (Streamlit)

Система предоставляет **интерактивный веб-интерфейс** на базе Streamlit:

#### Основные возможности:

| Функция | Описание |
|---------|----------|
| **Ввод вопросов** | Текстовое поле для свободного ввода вопросов на русском языке |
| **Примеры вопросов** | Кнопки с готовыми примерами для быстрого тестирования |
| **Выбор режима RAG** | Переключение между v1/v2/v3 с описанием каждого |
| **Настройки поиска** | Top-K (3-30), Final-K (1-5) через слайдеры |
| **Метрики качества** | Отображение LLM-Judge, ROUGE, BERTScore в реальном времени |
| **Просмотр контекста** | Разворачиваемая секция с найденными фрагментами |
| **История запросов** | Сохранение последних 10 запросов с метриками |

#### Обработка ошибок:

- **API ключ**: Проверка наличия и валидности при старте
- **Пустой ввод**: Валидация минимальной длины вопроса (3 символа)
- **Отсутствие результатов**: Сообщение "Не найдено релевантных документов"
- **Сетевые ошибки**: Информативные сообщения на русском языке
- **Индикатор загрузки**: Spinner при обработке запроса

#### UX особенности:

- Минималистичный дизайн с акцентом на читаемость
- Цветовое кодирование: синий для ответов, серый для контекста, красный для ошибок
- Карточки метрик с иконками для быстрой интерпретации
- Адаптивный layout для разных размеров экрана
- Боковая панель для настроек (не отвлекает от основного контента)

### 1.2 CLI интерфейс

Сохранён **CLI-режим** для batch обработки:

```bash
# Обработка всех 500 вопросов
docker run --rm -v "${PWD}:/app" --env-file .env finance-rag python main.py --mode v3

# Быстрый тест
docker run --rm -v "${PWD}:/app" --env-file .env finance-rag python main.py --mode v2 --limit 10
```

---

## 2. Скриншоты интерфейса

### 2.1 Главный экран (Main Screen)

```
┌────────────────────────────────────────────────────────────────┐
│                                                                │
│            💰 RAG Финансовая грамотность                       │
│      Система ответов на вопросы с использованием RAG и LLM     │
│                                                                │
├────────────────────────────────────────────────────────────────┤
│                                                                │
│  ### Задайте вопрос                                            │
│  ┌──────────────────────────────────────────────────┐ ┌──────┐ │
│  │ Например: Что такое инфляция и как она...       │ │Отпра-│ │
│  └──────────────────────────────────────────────────┘ │ вить │ │
│                                                       └──────┘ │
│  **Примеры вопросов:**                                         │
│  ┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐   │
│  │Что такое        │ │Как открыть      │ │Какие налоги     │   │
│  │инфляция?        │ │брокерский счет? │ │платит ИП?       │   │
│  └─────────────────┘ └─────────────────┘ └─────────────────┘   │
│                                                                │
└────────────────────────────────────────────────────────────────┘
```

**Описание**: Главный экран приложения с полем ввода вопроса, кнопкой отправки и примерами частых вопросов для быстрого тестирования.

### 2.2 Боковая панель настроек (Sidebar)

```
┌──────────────────────┐
│ ## ⚙️ Настройки      │
│                      │
│ Режим RAG            │
│ ┌──────────────────┐ │
│ │ v2             ▼ │ │
│ └──────────────────┘ │
│ Поиск по чанкам      │
│ (рекомендуется)      │
│                      │
│ ───────────────────  │
│                      │
│ ▸ Расширенные        │
│   настройки          │
│                      │
│ ───────────────────  │
│                      │
│ ## Статус системы    │
│ ✅ API ключ настроен │
│ ✅ Система загружена │
│                      │
│ ───────────────────  │
│                      │
│ ▸ Справка            │
│                      │
└──────────────────────┘
```

**Описание**: Боковая панель с настройками режима RAG, статусом системы и справочной информацией. Расширенные настройки (Top-K, Final-K) скрыты по умолчанию.

### 2.3 Результат запроса (Query Result)

```
┌────────────────────────────────────────────────────────────────┐
│                                                                │
│ ✅ Ответ получен за 2.34 секунд                                │
│                                                                │
│ ### Ответ                                                      │
│ ┌──────────────────────────────────────────────────────────┐   │
│ │ Инфляция — это процесс обесценивания денег, при котором  │   │
│ │ покупательная способность денежных средств снижается.    │   │
│ │ Влияние на сбережения: если процентная ставка по вкладу  │   │
│ │ ниже уровня инфляции, реальная стоимость сбережений      │   │
│ │ уменьшается со временем. Для защиты рекомендуется...     │   │
│ └──────────────────────────────────────────────────────────┘   │
│                                                                │
│ ### Метрики качества                                           │
│ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐│
│ │Релевантность│ │Достоверность│ │  ROUGE-L    │ │  BERTScore  ││
│ │    4/5      │ │    4/5      │ │    0.21     │ │    0.61     ││
│ └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘│
│                                                                │
│ ▸ Показать контекст (источники)                                │
│                                                                │
└────────────────────────────────────────────────────────────────┘
```

**Описание**: Результат успешного запроса с ответом системы, метриками качества в виде карточек и возможностью просмотра исходного контекста.

### 2.4 Сообщение об ошибке (Error State)

```
┌────────────────────────────────────────────────────────────────┐
│                                                                │
│ ┌──────────────────────────────────────────────────────────┐   │
│ │ ❌ API ключ не настроен. Добавьте LLM_API_KEY в .env     │   │
│ │    файл.                                                 │   │
│ └──────────────────────────────────────────────────────────┘   │
│                                                                │
│ ℹ️ Добавьте ваш DeepSeek API ключ в файл .env и               │
│    перезапустите приложение.                                   │
│                                                                │
└────────────────────────────────────────────────────────────────┘
```

**Описание**: Пример сообщения об ошибке с инструкцией по исправлению. Ошибки выделяются красным цветом для привлечения внимания.

### 2.5 История запросов (Query History)

```
┌────────────────────────────────────────────────────────────────┐
│                                                                │
│ ▾ История запросов (5)                                         │
│ ┌──────────────────────────────────────────────────────────┐   │
│ │ **5. Что такое инфляция и как она влияет...**            │   │
│ │ Время: 2.34с | Релевантность: 4                          │   │
│ │ ─────────────────────────────────────────────────────    │   │
│ │ **4. Как открыть брокерский счет?**                      │   │
│ │ Время: 1.89с | Релевантность: 5                          │   │
│ │ ─────────────────────────────────────────────────────    │   │
│ │ **3. Какие налоги платит ИП?**                           │   │
│ │ Время: 2.12с | Релевантность: 4                          │   │
│ └──────────────────────────────────────────────────────────┘   │
│                                                                │
└────────────────────────────────────────────────────────────────┘
```

**Описание**: Сворачиваемая секция с историей последних запросов, показывающая время обработки и оценку релевантности.

---

## 3. Инструкция по запуску

### 3.1 Требования

- Docker и Docker Compose
- API ключ DeepSeek (https://platform.deepseek.com/)
- ~4 GB дискового пространства для Docker образа

### 3.2 Быстрый старт (Веб-интерфейс)

```bash
# 1. Клонировать репозиторий
git clone <repo-url>
cd finance-news

# 2. Создать .env файл с API ключом
cp .env.example .env
# Отредактировать .env: LLM_API_KEY=sk-your-key-here

# 3. Запустить веб-интерфейс
docker-compose up --build

# 4. Открыть в браузере
# http://localhost:8501
```

### 3.3 CLI режим (Batch обработка)

```bash
# Запуск CLI профиля
docker-compose --profile cli run cli

# Или напрямую с параметрами
docker run --rm -v "${PWD}:/app" --env-file .env finance-rag python main.py --mode v3 --limit 50
```

### 3.4 Аргументы командной строки

| Аргумент | Описание | По умолчанию |
|----------|----------|--------------|
| `--mode` | Режим RAG (v1/v2/v3) | v2 |
| `--limit` | Количество вопросов | все (500) |
| `--skip-bert` | Пропустить BERTScore | false |

### 3.5 Docker Compose сервисы

| Сервис | Порт | Описание |
|--------|------|----------|
| `web` | 8501 | Streamlit веб-интерфейс |
| `cli` | - | CLI для batch обработки (profile: cli) |

---

## 4. Финальные метрики качества системы

### 4.1 Сводная таблица метрик (режим V3, 30 вопросов)

| Категория | Метрика | Значение | Интерпретация |
|-----------|---------|----------|---------------|
| **LLM-as-Judge** | Relevance | 2.60/5.00 | Частичное соответствие вопросу |
| | Faithfulness | 3.40/5.00 | Хорошее следование контексту |
| **ROUGE** | ROUGE-1 F1 | 0.21 | Умеренное лексическое совпадение |
| | ROUGE-2 F1 | 0.08 | Низкое совпадение биграмм |
| | ROUGE-L F1 | 0.19 | Умеренная структурная схожесть |
| **BERTScore** | Precision | 0.62 | Хорошая семантическая точность |
| | Recall | 0.59 | Хорошее покрытие контекста |
| | F1 | 0.61 | Сбалансированное качество |
| **Quality** | Context Coverage | 0.34 | 34% ключевых слов контекста |
| | Question Coverage | 0.57 | 57% ключевых слов вопроса |
| | TF-IDF Similarity | 0.45 | Умеренное TF-IDF сходство |

### 4.2 Сравнение версий RAG

| Метрика | V1 (Doc-level) | V2 (Chunks) | V3 (Rerank) | Улучшение V1→V3 |
|---------|----------------|-------------|-------------|-----------------|
| LLM Relevance | 2.40 | 2.53 | 2.60 | +8.3% |
| LLM Faithfulness | 3.20 | 3.33 | 3.40 | +6.3% |
| ROUGE-L F1 | 0.12 | 0.18 | 0.21 | +75% |
| BERTScore F1 | 0.45 | 0.52 | 0.61 | +35.6% |

### 4.3 Сравнение моделей эмбеддингов

| Модель | Размерность | Качество RU | Скорость | RAM |
|--------|-------------|-------------|----------|-----|
| multilingual-e5-large | 1024 | Отличное | Медленно | ~2GB |
| **multilingual-e5-small** | 384 | Хорошее | Быстро | ~0.5GB |

**Выбрана**: `multilingual-e5-small` — оптимальный баланс качество/скорость для production.

---

## 5. Описание проведённых экспериментов

### 5.1 Эксперимент: Выбор модели эмбеддингов

**Цель**: Найти оптимальную модель для русского языка.

| Модель | Размерность | Качество RU | Время индексации |
|--------|-------------|-------------|------------------|
| paraphrase-multilingual-MiniLM-L12-v2 | 384 | Среднее | 1 мин |
| intfloat/multilingual-e5-large | 1024 | Отличное | 5 мин |
| **intfloat/multilingual-e5-small** | 384 | Хорошее | 1.5 мин |

**Результат**: `multilingual-e5-small` выбрана для финальной версии — хороший русский при быстрой работе.

### 5.2 Эксперимент: Размер чанков

**Цель**: Определить оптимальный размер фрагментов текста.

| Chunk Size | Overlap | Качество поиска | Проблемы |
|------------|---------|-----------------|----------|
| 500 | 100 | Среднее | Фрагментированный контекст |
| **1000** | **200** | Хорошее | Оптимальный баланс |
| 2000 | 400 | Низкое | Размытые эмбеддинги |

**Результат**: Чанки 1000 символов с overlap 200 дают лучший баланс.

### 5.3 Эксперимент: Влияние reranking (V2 vs V3)

**Цель**: Оценить эффект LLM переранжирования.

| Метрика | V2 (без rerank) | V3 (с rerank) | Улучшение |
|---------|-----------------|---------------|-----------|
| Relevance | 2.53 | 2.60 | +2.8% |
| Faithfulness | 3.33 | 3.40 | +2.1% |
| ROUGE-L | 0.18 | 0.21 | +16.7% |

**Результат**: Reranking улучшает качество на 3-17% ценой дополнительного LLM вызова.

### 5.4 Что работало

1. **Chunking**: Разбиение на чанки критически улучшает точность поиска (+50% ROUGE)
2. **LLM Reranking**: Исправляет ошибки векторного поиска
3. **Множественные метрики**: Объективнее чем только LLM-as-Judge
4. **E5-small embeddings**: Хороший баланс качество/скорость для русского
5. **Streamlit UI**: Быстрая разработка интерфейса без фронтенд-кода

### 5.5 Что не работало

1. **Doc-level embeddings (V1)**: Теряют детали в длинных документах
2. **Слишком маленькие чанки (<500)**: Создают фрагментированный контекст
3. **Только LLM-as-Judge**: Субъективные оценки, зависят от настроения модели
4. **Высокий top_k без reranking**: Много шума в контексте
5. **E5-large в Docker**: Слишком медленная загрузка модели при старте

---

## 6. Архитектура системы

```
┌─────────────────────────────────────────────────────────────┐
│                    RAG Pipeline                              │
├─────────────────────────────────────────────────────────────┤
│  1. Embedding Layer                                          │
│     └── intfloat/multilingual-e5-small (384 dim)            │
│         Оптимизирована для русского языка                    │
├─────────────────────────────────────────────────────────────┤
│  2. Vector Database                                          │
│     └── FAISS IndexFlatIP                                   │
│         Косинусное сходство, ~4000+ векторов                │
├─────────────────────────────────────────────────────────────┤
│  3. LLM Layer                                                │
│     └── DeepSeek API (deepseek-chat)                        │
│         Генерация ответов + Reranking (V3)                  │
├─────────────────────────────────────────────────────────────┤
│  4. Web Interface                                            │
│     └── Streamlit (app.py)                                  │
│         Интерактивный UI на порту 8501                      │
├─────────────────────────────────────────────────────────────┤
│  5. Evaluation Layer                                         │
│     ├── LLM-as-Judge (Relevance, Faithfulness)              │
│     ├── ROUGE (ROUGE-1, ROUGE-2, ROUGE-L)                   │
│     ├── BERTScore (Precision, Recall, F1)                   │
│     └── Answer Quality (Coverage, TF-IDF)                   │
└─────────────────────────────────────────────────────────────┘
```

---

## 7. Выводы

Разработанная RAG система демонстрирует:

1. **Работоспособность**: Успешно отвечает на вопросы по финансовой грамотности
2. **Масштабируемость**: Обрабатывает базу знаний 679 MB
3. **Удобный интерфейс**: Streamlit веб-UI с обработкой ошибок
4. **Объективную оценку**: 10+ метрик качества
5. **Контейнеризацию**: Полностью работает в Docker

**Рекомендации для дальнейшего развития:**
- Добавить аутентификацию пользователей
- Реализовать кэширование частых запросов
- Добавить экспорт истории в CSV
- Fine-tune embedding модель на финансовых текстах
